#!/bin/bash

set -e

if [ "$EUID" -ne 0 ]
  then echo "Please run as root"
  exit
fi

URL="{{ shyft_chainspec_url }}"
LOCATION="{{ nethermind_location }}/chainspec.json"
SERVICE_USER="{{ service_user }}"

TEMP_FILE=$(mktemp)
curl -s -o $TEMP_FILE $URL

echo "Comparing $URL to $LOCATION"

# Check if the file size is at least 5kb
if [ $(stat -c%s "$TEMP_FILE") -ge 5120 ]; then
    # Check if the file is a valid JSON
    if cat $TEMP_FILE | jq . > /dev/null 2>&1; then
        # Compare the temporary file to the existing file
        if ! cmp -s $TEMP_FILE $LOCATION; then
            echo "Files are different. New chainspec installed. Restarting service."
            cp $TEMP_FILE $LOCATION
	    chown $SERVICE_USER $LOCATION
            systemctl restart nethermind
        else
            echo "Files are identical. Doing nothing."
        fi
    else
        echo "File is not a valid JSON. Rejecting the file."
    fi
else
    echo "File size is less than 5kb. Rejecting the file."
fi

rm $TEMP_FILE

